{% extends "base.html" %}

    {% block css %}
    {{super()}}
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='lib/leaflet/dist/leaflet.css')}}">
        <style type="text/css">
        .chart rect {
          fill: steelblue;
        }

        .chart text {
          fill: white;
          font: 10px sans-serif;
        }

        .chart text.number {
          text-anchor: end;
        }

        .chart text.text {
          fill: black;
        }

        #map {
            height: 400px;
            width: 100%;
        }
        </style>
    {% endblock %}


    {% block main %}
    <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2">
        <h1>Statistikk</h1>

        <h2>Bryggerier pr kommune</h2>
        <svg class="chart chart-breweries"></svg>

        <h2>Pol pr kommune</h2>
        <svg class="chart chart-pol"></svg>

        <h2>Puber pr kommune</h2>
        <svg class="chart chart-pubs"></svg>

        <h2>Hexmap</h2>
        <div id="map"></div>
    </div>
    {% endblock %}

    {% block script %}
    {{super()}}
    <script type="text/javascript" src="{{ url_for('static', filename='lib/d3/d3.min.js')}}"></script>

    <script type="text/javascript" src="{{ url_for('static', filename='lib/leaflet/dist/leaflet.js')}}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='lib/L.TileLayer.Kartverket/dist/L.TileLayer.Kartverket.min.js')}}"></script>

    <script type="text/javascript">
        (function () {
            'use strict';

            function renderHexmap(geoJson) {
                var map = L.map('map').setView([65.5, 17.0], 4);

                L.tileLayer.kartverket('norges_grunnkart').addTo(map);

                var colors = [
                    '#F7FBFF',
                    '#C7DCEF',
                    '#72B2D7',
                    '#2878B8',
                    '#08306B'
                ];

                L.geoJson(geoJson,{
                    style: function (feature) {

                        var color;
                        if (feature.properties.count === 0) {
                            color = colors[0];
                        } else if (feature.properties.count < 20) {
                            color = colors[1];
                        } else if (feature.properties.count < 40) {
                            color = colors[2];
                        } else if (feature.properties.count < 60) {
                            color = colors[3];
                        } else {
                            color = colors[3];
                        }


                        return {
                            weight: 1,
                            color: '#000',
                            fillColor: color,
                            fillOpacity: 0.8
                        };
                    }
                }).addTo(map);
            }


            function renderChart(data, element) {
                var width = 420,
                barHeight = 20;

                var x = d3.scale.linear()
                    .domain([0, d3.max(_.pluck(data, 'num'))])
                    .range([0, width - 40]);

                var chart = d3.select("." + element)
                    .attr("width", width)
                    .attr("height", barHeight * data.length);

                var bar = chart.selectAll("g")
                    .data(data)
                  .enter().append("g")
                    .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });

                var g = bar.append('g')
                    .attr('transform', 'translate(40, 0)');

                g.append("rect")
                    .attr("width", function(d) {return x(d.num); })
                    .attr("height", barHeight - 1);

                g.append("text")
                    .attr("class", 'number')
                    .attr("x", function(d) { return x(d.num) - 3; })
                    .attr("y", barHeight / 2)
                    .attr("dy", ".35em")
                    .text(function(d) { return d.num;});

                bar.append("text")
                    .attr("x", 2)
                    .attr("class", 'text')
                    .attr("y", barHeight / 2)
                    .attr("dy", ".35em")
                    .text(function(d) { return d.navn;});
            }

            var stats = {{stats | safe}};
            console.log(stats.hex);
            renderChart(_.first(stats.breweries, 10), 'chart-breweries');
            renderChart(_.first(stats.pol, 10), 'chart-pol');

            renderChart(_.first(stats.pubs, 10), 'chart-pubs');


            renderHexmap(stats.hex);

        }());

    </script>

    {% endblock %}